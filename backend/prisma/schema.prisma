generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Folder {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  icon        String?
  color       String?
  description String?   @db.Text
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  sessions    Session[]
  memories    Memory[]

  @@index([userId])
  @@index([userId, isDefault])
  @@map("folders")
}

model Session {
  id               String      @id @default(cuid())
  userId           String      @map("user_id")
  folderId         String?     @map("folder_id")
  folder           Folder?     @relation(fields: [folderId], references: [id], onDelete: SetNull)
  name             String?
  status           String      @default("active")
  lastCheckpointId String?     @map("last_checkpoint_id") // è®°ä½ç”¨æˆ·ä¸Šæ¬¡åˆ†æ”¯
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  lastMessageAt    DateTime?   @map("last_message_at")

  messages   Message[]
  reasonings Reasoning[]
  feedbacks  Feedback[]

  @@index([userId])
  @@index([userId, status])
  @@index([folderId])
  @@index([status])
  @@map("sessions")
}

model Reasoning {
  id           String   @id @default(cuid())
  sessionId    String   @map("session_id")
  session      Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  checkpointId String   @unique @map("checkpoint_id") // LangGraph checkpoint ID
  content      String   @db.Text
  duration     Int? // æ€è€ƒæ—¶é•¿ï¼ˆmsï¼‰
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([checkpointId])
  @@map("reasonings")
}

model Memory {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  folderId  String?   @map("folder_id")
  folder    Folder?   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  scope     String    @default("folder")
  category  String    @default("general")
  key       String
  value     Json
  priority  Int       @default(0)
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([userId, folderId, scope, category, key])
  @@index([userId])
  @@index([userId, scope])
  @@index([folderId])
  @@index([expiresAt])
  @@map("memories")
}

model Message {
  id        String   @id @default(cuid())
  sessionId String   @map("session_id")
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  seq       Int
  role      String
  content   String?  @db.Text
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  toolCalls ToolCall[]

  @@unique([sessionId, seq])
  @@index([sessionId])
  @@index([sessionId, seq])
  @@index([role])
  @@map("messages")
}

model ToolCall {
  id         String   @id @default(cuid())
  messageId  String   @map("message_id")
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  seq        Int
  toolCallId String   @map("tool_call_id")
  toolName   String   @map("tool_name")
  args       Json
  result     Json?
  status     String   @default("pending")
  duration   Int?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([messageId, seq])
  @@index([messageId])
  @@index([toolName])
  @@map("tool_calls")
}

model Document {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  collection String   @default("default")
  content    String   @db.Text
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, collection])
  @@index([collection])
  @@map("documents")
}

/// ç´¢å¼•è®°å½• - ç”¨äºè·Ÿè¸ªå·²ç´¢å¼•çš„æ–‡æ¡£ï¼Œé¿å…é‡å¤ embedding
model IndexedRecord {
  id          String   @id @default(cuid())
  sourceId    String   @map("source_id")   // æ–‡æ¡£æ¥æºæ ‡è¯†ç¬¦
  contentHash String   @map("content_hash") // å†…å®¹å“ˆå¸Œï¼Œç”¨äºæ£€æµ‹å˜æ›´
  collection  String   @default("default")
  indexedAt   DateTime @default(now()) @map("indexed_at")

  @@unique([sourceId, collection])
  @@index([collection])
  @@index([contentHash])
  @@map("indexed_records")
}

/// ç”¨æˆ·åé¦ˆ - æ”¶é›†å¯¹ AI å›ç­”çš„è¯„ä»·
model Feedback {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")   // å…³è”çš„æ¶ˆæ¯ ID
  sessionId String   @map("session_id")
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  score     Int                           // 1 = ğŸ‘, -1 = ğŸ‘
  comment   String?  @db.Text             // å¯é€‰çš„ç”¨æˆ·è¯„è®º
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([messageId])
  @@index([score])
  @@index([createdAt])
  @@map("feedbacks")
}

/// ç”¨æˆ·æ¡£æ¡ˆ - é•¿æœŸè®°å¿† (Patch æ¨¡å¼)
/// å•ä¸€æ–‡æ¡£æŒç»­æ›´æ–°ï¼Œå­˜å‚¨ç”¨æˆ·åå¥½ã€ç‰¹å¾ç­‰
model UserProfile {
  id                      String    @id @default(cuid())
  userId                  String    @unique @map("user_id")
  preferredName           String?   @map("preferred_name")
  age                     Int?
  interests               String[]
  occupation              String?
  location                String?
  conversationPreferences String[]  @map("conversation_preferences")
  relationships           Json?     // Array<{name, relation, notes}>
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@map("user_profiles")
}

/// ä¸­æœŸè®°å¿† - æƒ…æ™¯è®°å¿† (Insert æ¨¡å¼)
/// å­˜å‚¨ä¼šè¯æ‘˜è¦ã€å…³é”®äº‹ä»¶ã€äº¤äº’ç‰‡æ®µç­‰ï¼Œæ”¯æŒè¯­ä¹‰æ£€ç´¢
/// æ³¨æ„ï¼šå‘é‡å­˜å‚¨é€šè¿‡ VectorStoreService å•ç‹¬å¤„ç†ï¼Œä½¿ç”¨ id ä½œä¸ºå…³è”
model EpisodicMemory {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  sessionId  String?   @map("session_id")
  type       String    // 'summary' | 'event' | 'interaction' | 'note' | 'relationship'
  content    String    @db.Text
  context    String    @db.Text  // æƒ…å¢ƒæè¿°
  importance Float     @default(0.5)
  createdAt  DateTime  @default(now()) @map("created_at")
  expiresAt  DateTime? @map("expires_at")

  @@index([userId])
  @@index([userId, type])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("episodic_memories")
}

/// æ ¸å¿ƒè®°å¿†å— - Agent å¯ç¼–è¾‘çš„ä¸Šä¸‹æ–‡å†…è®°å¿†
/// å‚è€ƒ Letta çš„ Block è®¾è®¡ï¼Œæ”¯æŒ persona/human ç­‰æ ‡ç­¾
model MemoryBlock {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  agentId     String?   @map("agent_id")
  label       String                        // 'persona' | 'human' | custom
  value       String    @db.Text @default("")
  limit       Int       @default(20000)     // å­—ç¬¦é™åˆ¶
  readonly    Boolean   @default(false)     // æ˜¯å¦åªè¯»
  description String?   @db.Text
  metadata    Json?                         // æ‰©å±•å…ƒæ•°æ®
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  history     MemoryBlockHistory[]

  @@unique([userId, label])
  @@index([userId])
  @@index([agentId])
  @@map("memory_blocks")
}

/// è®°å¿†å†å² - è¿½è¸ªæ‰€æœ‰è®°å¿†å˜æ›´
/// æ”¯æŒ episodic/block/store ä¸‰ç§ç±»å‹çš„è®°å¿†å†å²
model MemoryHistory {
  id            String   @id @default(cuid())
  memoryId      String   @map("memory_id")
  memoryType    String   @map("memory_type") // 'episodic' | 'block' | 'store'
  userId        String   @map("user_id")
  event         String   // 'ADD' | 'UPDATE' | 'DELETE' | 'NONE'
  previousValue String?  @db.Text @map("previous_value")
  newValue      String?  @db.Text @map("new_value")
  actorId       String?  @map("actor_id") // 'user' | 'agent' | 'system'
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([memoryId])
  @@index([userId])
  @@index([userId, memoryType])
  @@index([createdAt])
  @@map("memory_history")
}

/// è®°å¿†å—å˜æ›´å†å² - è¿½è¸ª Core Memory çš„æ‰€æœ‰ç¼–è¾‘
model MemoryBlockHistory {
  id            String      @id @default(cuid())
  blockId       String      @map("block_id")
  block         MemoryBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  label         String
  event         String      // 'APPEND' | 'REPLACE' | 'RETHINK' | 'DELETE'
  previousValue String      @db.Text @map("previous_value")
  newValue      String      @db.Text @map("new_value")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([blockId])
  @@index([userId])
  @@index([createdAt])
  @@map("memory_block_history")
}

